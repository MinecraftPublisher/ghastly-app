<!DOCTYPE html>
<html>

<head>
    <!--NAME-->
    <title>Scary stories</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f0f0f">
    <link rel="stylesheet" href="/styles/global.css">
    <link rel="shortcut icon" href="/assets/icon.webp">
    <link rel="apple-touch-icon" href="/assets/icon.webp">
    <script defer="defer" src="/text.js"></script>
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-NVJ7TF8');</script>
    <!-- End Google Tag Manager -->
    <meta name="google-site-verification" content="_PCrbFjvhLwdhDrQj5Bm5FB_SXjd05XWonARwGn2oMY" />
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NVJ7TF8" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <main>
        <br>
        <h1 style="margin-bottom: -1rem;">
            <!--NAME--> Scary stories (loading assets)
        </h1>
        <br>
        <list></list>
    </main>
    <footer>
        <a href="https://www.netlify.com/">Hosted with netlify</a>
        <a href="/read?pack=/stories/submit_story.html&title=Submit%20a%20story&language=english">Submit a story</a>
        <a href="/read?pack=/stories/credits.txt&title=Credits&language=english">Credits</a>
    </footer>

    <script>
        // wait for the audio to load.
        window.onload = () => {
            playsound = false;
            document.querySelector('main > h1').innerHTML = 'Scary stories';
            // get data
            fetch('/stories/index.json').then(e => e.text()).then(data => {
                let stories = JSON.parse(data);
                let list = document.querySelector('list');
                message('author', 'minecraftpublisher');
                message(true, 'Do you know some good stories to read?');
                setTimeout(() => {
                    message(false, 'Sure!');
                    setTimeout(() => {
                        message(false, 'I have some to share. Click on a message below to read it.');
                        setTimeout(() => {
                            for (let story of stories) {
                                let elm = message(false, story.name, story.description, false);
                                elm.querySelector('message').setAttribute('clickable', '1');
                                elm.onclick = () => {
                                    window.location.href = `/read?pack=${story.url}&title=${story.name}&language=${story.language}`;
                                };
                            }
                        }, 500);
                    }, 800);
                }, 800);
            });
        };

        // register the service worker
        let version = 'v4';
        if ('serviceWorker' in navigator) {
            if (localStorage.getItem('registered') !== version) {
                // deregister service worker
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for (let registration of registrations) {
                        registration.unregister();
                    }

                    // register service worker
                    navigator.serviceWorker.register('/sw.js').then(registration => {
                        message(false, 'By the way, The game assets are fully loaded. All sounds should be working now!', 'minecraftpublisher');
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        localStorage.setItem('registered', version);
                    }).catch(err => {
                        message(false, 'Something went wrong in the app, Sounds might be delayed. Perhaps we don\'t support this device?', 'minecraftpublisher');
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }
        }
    </script>
</body>

</html>