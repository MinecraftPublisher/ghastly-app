<!DOCTYPE html>
<html>

<head>
    <!--NAME-->
    <title>Ghastly</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f0f0f">
    <link rel="stylesheet" href="/styles/global.css">
    <link rel="shortcut icon" href="/assets/favicon.png">
    <link rel="apple-touch-icon" href="/assets/favicon.png">
    <script defer="defer" src="/text.js"></script>
</head>

<body>
    <script src="/song.js"></script>
    <main>
        <br>
        <h1 style="margin-bottom: -1rem;">
            <!--NAME--> Ghastly (loading assets)
        </h1>
        <br>
        <list></list>
    </main>
    <footer>
        <a href="/read?pack=/stories/guide.txt&title=Submit%20a%20story%20guide&language=english">Submit a story
            guide</a>
        <a href="/read?pack=/stories/submit.html&title=Submit%20a%20story&language=english">Submit a story</a>
        <a href="/read?pack=/stories/credits.txt&title=Credits&language=english">Credits</a>
    </footer>
    <ghost onclick="window.open('https://github.com/MinecraftPublisher');"></ghost>
    <netlify onclick="window.open('https://www.netlify.com/');"></netlify>

    <script>
        // wait for the audio to load.
        window.onload = () => {
            function timeDifference(current, previous) {

                var msPerMinute = 60 * 1000;
                var msPerHour = msPerMinute * 60;
                var msPerDay = msPerHour * 24;
                var msPerMonth = msPerDay * 30;
                var msPerYear = msPerDay * 365;

                var elapsed = current - previous;

                if (elapsed < msPerMinute) {
                    return Math.round(elapsed / 1000) + ' seconds ago';
                }

                else if (elapsed < msPerHour) {
                    return Math.round(elapsed / msPerMinute) + ' minutes ago';
                }

                else if (elapsed < msPerDay) {
                    return Math.round(elapsed / msPerHour) + ' hours ago';
                }

                else if (elapsed < msPerMonth) {
                    return 'approximately ' + Math.round(elapsed / msPerDay) + ' days ago';
                }

                else if (elapsed < msPerYear) {
                    return 'approximately ' + Math.round(elapsed / msPerMonth) + ' months ago';
                }

                else {
                    return 'approximately ' + Math.round(elapsed / msPerYear) + ' years ago';
                }
            }

            fetch('/last-deploy').then(e => e.text()).then(data => {
                let difference = timeDifference(+new Date(), data);
                let URL = 'https://img.shields.io/badge/last%20publish-' + encodeURI(difference) + '-9cf';
                document.querySelector('main > h1').innerHTML = 'Ghastly<br><img src="' + URL + '" alt="last publish: ' + difference + '"><br>';
            });

            playsound = false;
            // get data
            fetch('/stories/index.json').then(e => e.text()).then(data => {
                let stories = JSON.parse(data);
                let list = document.querySelector('list');
                message('author', 'houston');
                message(true, 'Do you know some good stories to read?');
                setTimeout(() => {
                    message(false, 'Sure!');
                    setTimeout(() => {
                        message(false, 'I have some to share. Click on a message below to read it.');
                        setTimeout(() => {
                            for (let story of stories) {
                                if (story.ready) {
                                    let elm = message(false, story.name, story.description, false, true);
                                    elm.querySelector('message').setAttribute('clickable', '1');
                                    elm.onclick = () => {
                                        window.location.href = `/read?pack=${story.url}&title=${story.name}&language=${story.language}`;
                                    };
                                }
                            }
                        }, 500);
                    }, 800);
                }, 800);
            });
        };

        // register the service worker
        let version = 'v4';
        if ('serviceWorker' in navigator) {
            if (localStorage.getItem('registered') !== version) {
                // deregister service worker
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for (let registration of registrations) {
                        registration.unregister();
                    }

                    // register service worker
                    navigator.serviceWorker.register('/sw.js').then(registration => {
                        localStorage.setItem('registered', version);
                        location.reload();
                    }).catch(err => {
                        message(false, 'Something went wrong in the app, Sounds might be delayed. Perhaps we don\'t support this device?', 'houston');
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }
        }
    </script>
</body>

</html>